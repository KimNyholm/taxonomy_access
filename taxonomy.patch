--- /root/drupal-4.5.0/modules/taxonomy.module	Mon Oct 18 12:46:19 2004
+++ /var/www/modules/taxonomy.module	Sun Oct 31 08:47:26 2004
@@ -106,7 +106,11 @@
     $result = db_query("SELECT d.tid, d.name, MAX(n.created) AS updated, COUNT(*) AS count FROM {term_data} d INNER JOIN {term_node} USING (tid) INNER JOIN {node} n USING (nid) WHERE n.status = 1 GROUP BY d.tid, d.name ORDER BY updated DESC, d.name");
     $items = array();
     while ($category = db_fetch_object($result)) {
-      $items[] = l($category->name .' ('. $category->count .')', 'taxonomy/term/'. $category->tid) .'<br />'. t('%time ago', array('%time' => format_interval(time() - $category->updated)));
+      if (function_exists('taxonomy_access'))  {
+        if (taxonomy_access('view',$category->tid))
+          $items[] = l($category->name .' ('. $category->count .')', 'taxonomy/term/'. $category->tid) .'<br />'. t('%time ago', array('%time' => format_interval(time() - $category->updated)));
+      } else // if taxonomy_access isn't installed
+        $items[] = l($category->name .' ('. $category->count .')', 'taxonomy/term/'. $category->tid) .'<br />'. t('%time ago', array('%time' => format_interval(time() - $category->updated)));        
     }
 
     $block['subject'] = t('Categories');
@@ -432,6 +436,9 @@
  * Determine whether a node mentions the name of a term.
  */
 function taxonomy_node_has_term($nid, $tid) {
+  if (function_exists('taxonomy_access'))
+    if (!taxonomy_access('view',$tid))
+      return FALSE;
   $term_name = db_result(db_query('SELECT name FROM {term_data} WHERE tid = %d', $tid));
 
   return db_result(db_query("SELECT COUNT(n.nid) FROM {node} n WHERE n.nid = %d AND ((n.title LIKE '%%%s%%') OR (n.body LIKE '%%%s%%'))", $nid, $term_name, $term_name));
@@ -444,7 +451,10 @@
   $result = db_query('SELECT t.* FROM {term_data} t, {term_node} r WHERE t.tid = r.tid AND t.vid = %d AND r.nid = %d ORDER BY weight', $vid, $nid);
   $terms = array();
   while ($term = db_fetch_object($result)) {
-    $terms[$term->$key] = $term;
+    if (function_exists('taxonomy_access'))  {
+      if (taxonomy_access('view',$term->tid))
+        $terms[$term->$key] = $term;
+    } else $terms[$term->$key] = $term;
   }
   return $terms;
 }
@@ -459,6 +469,10 @@
     $result = db_query('SELECT t.* FROM {term_data} t, {term_node} r WHERE r.tid = t.tid AND r.nid = %d ORDER BY weight, name', $nid);
     $terms[$nid] = array();
     while ($term = db_fetch_object($result)) {
+     if (function_exists('taxonomy_access'))  {
+       if (taxonomy_access('view',$term->tid))
+        $terms[$nid][$term->$key] = $term;
+     } else $terms[$nid][$term->$key] = $term;
       $terms[$nid][$term->$key] = $term;
     }
   }
@@ -474,7 +488,10 @@
   if ($terms) {
     foreach ($terms as $term) {
       if ($term) {
-        db_query('INSERT INTO {term_node} (nid, tid) VALUES (%d, %d)', $nid, $term);
+        if (function_exists('taxonomy_access'))  {
+           if (taxonomy_access('update',$term))
+             db_query('INSERT INTO {term_node} (nid, tid) VALUES (%d, %d)', $nid, $term);
+        } else db_query('INSERT INTO {term_node} (nid, tid) VALUES (%d, %d)', $nid, $term);
       }
     }
   }
@@ -495,7 +512,10 @@
     $result = db_query('SELECT t.*, tid1, tid2 FROM {term_relation}, {term_data} t WHERE (t.tid = tid1 OR t.tid = tid2) AND (tid1 = %d OR tid2 = %d) AND t.tid != %d ORDER BY weight, name', $tid, $tid, $tid);
     $related = array();
     while ($term = db_fetch_object($result)) {
-      $related[$term->$key] = $term;
+        if (function_exists('taxonomy_access'))  {
+           if (taxonomy_access('view',$term->tid))
+            $related[$term->$key] = $term;
+        } else $related[$term->$key] = $term;
     }
     return $related;
   }
@@ -512,7 +532,10 @@
     $result = db_query('SELECT t.* FROM {term_hierarchy} h, {term_data} t WHERE h.parent = t.tid AND h.tid = %d ORDER BY weight, name', $tid);
     $parents = array();
     while ($parent = db_fetch_object($result)) {
-      $parents[$parent->$key] = $parent;
+        if (function_exists('taxonomy_access'))  {
+           if (taxonomy_access('view',$parent->tid))
+            $parents[$parent->$key] = $parent;
+        } else $parents[$parent->$key] = $parent;
     }
     return $parents;
   }
@@ -549,7 +572,10 @@
   }
   $children = array();
   while ($term = db_fetch_object($result)) {
-    $children[$term->$key] = $term;
+    if (function_exists('taxonomy_access'))  {
+       if (taxonomy_access('view',$term->tid))
+        $children[$term->$key] = $term;
+    } else $children[$term->$key] = $term;
   }
   return $children;
 }
@@ -586,9 +612,17 @@
 
     $result = db_query('SELECT t.*, parent FROM {term_data} t, {term_hierarchy} h WHERE t.tid = h.tid AND t.vid = %d ORDER BY weight, name', $vid);
     while ($term = db_fetch_object($result)) {
-      $children[$vid][$term->parent][] = $term->tid;
-      $parents[$vid][$term->tid][] = $term->parent;
-      $terms[$vid][$term->tid] = $term;
+      if (function_exists('taxonomy_access'))  {
+         if (taxonomy_access('view',$term->tid))  {
+          $children[$vid][$term->parent][] = $term->tid;
+          $parents[$vid][$term->tid][] = $term->parent;
+          $terms[$vid][$term->tid] = $term; 
+         }
+      } else {
+        $children[$vid][$term->parent][] = $term->tid;
+        $parents[$vid][$term->tid][] = $term->parent;
+        $terms[$vid][$term->tid] = $term;
+      }
     }
   }
 
@@ -667,7 +701,10 @@
   if (!isset($children)) {
     $result = db_query('SELECT tid, parent FROM {term_hierarchy}');
     while ($term = db_fetch_object($result)) {
-      $children[$term->parent][] = $term->tid;
+      if (function_exists('taxonomy_access'))  {
+         if (taxonomy_access('view',$term->tid))
+           $children[$term->parent][] = $term->tid;
+      } else $children[$term->parent][] = $term->tid;
     }
   }
   return $children[$tid] ? $children[$tid] : array();
@@ -711,7 +748,10 @@
   $db_result = db_query("SELECT * FROM {term_data} WHERE LOWER('%s') LIKE LOWER(name)", trim($name));
   $result = array();
   while ($term = db_fetch_object($db_result)) {
-    $result[] = $term;
+    if (function_exists('taxonomy_access'))  {
+       if (taxonomy_access('view',$term->tid))
+        $result[] = $term;
+    } else $result[] = $term;
   }
 
   return $result;
@@ -728,6 +768,10 @@
  * Return the term object matching a term ID.
  */
 function taxonomy_get_term($tid) {
+    if (function_exists('taxonomy_access'))
+       if (!taxonomy_access('view',$term->tid))
+        return FALSE;
+
   // simple cache using a static var?
   return db_fetch_object(db_query('SELECT * FROM {term_data} WHERE tid = %d', $tid));
 }
@@ -893,6 +937,19 @@
   }
   else {
     drupal_not_found();
+  }
+
+  if (function_exists('taxonomy_access'))  {
+    $access_tids = array();
+    foreach($tids as $tid)
+      if (taxonomy_access('view',$tid))
+        $access_tids[] = $tid;
+    if ($access_tids)
+      $tids = $access_tids;
+    else {
+      drupal_access_denied();
+      return;
+    }
   }
 
   if ($tids) {
